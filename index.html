<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>لوحة تحكم One Sport Tv</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 10px;
        }
        .container {
            max-width: 700px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        h2 { text-align: center; margin-bottom: 15px; }
        label { display: block; margin: 8px 0 4px; }
        input[type=text], select {
            width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;
        }
        button {
            margin-top: 12px;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
        }
        .sections-list, .channels-list {
            margin-top: 25px;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background: #fafafa;
        }
        .item {
            padding: 6px 10px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item:last-child {
            border-bottom: none;
        }
        .btn-delete, .btn-edit {
            background: #dc3545;
            border: none;
            color: white;
            padding: 5px 8px;
            margin-left: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .btn-edit {
            background: #007bff;
        }
        .header-flex {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .header-flex button {
            width: auto;
            padding: 6px 12px;
            background-color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>لوحة تحكم One Sport Tv</h2>

        <div class="header-flex">
            <h3>إدارة الأقسام</h3>
            <div>
                <button onclick="openAddMainSection()">+ إضافة قسم رئيسي</button>
                <button onclick="openAddSubSection()">+ إضافة قسم فرعي</button>
            </div>
        </div>
        <div class="sections-list" id="sectionsList">
            جارٍ تحميل الأقسام...
        </div>

        <hr>

        <div class="header-flex">
            <h3>إدارة القنوات</h3>
            <button onclick="openAddChannel()">+ إضافة قناة جديدة</button>
        </div>
        <div class="channels-list" id="channelsList">
            جارٍ تحميل القنوات...
        </div>

        <!-- نماذج الإضافة والتعديل -->
        <div id="modal" style="display:none; position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.6);">
            <div style="background:white; max-width: 400px; margin: 80px auto; padding: 20px; border-radius: 8px; position: relative;">
                <h3 id="modalTitle"></h3>
                <form id="modalForm">
                    <input type="hidden" id="editId" />
                    <!-- القسم -->
                    <div id="sectionFields" style="display:none;">
                        <label for="nameInput">اسم القسم:</label>
                        <input type="text" id="nameInput" required />
                        <label for="imageInput" id="labelImageInput">رابط الصورة:</label>
                        <input type="text" id="imageInput" />
                        <label for="parentSelect" id="labelParentSelect" style="display:none;">القسم الأب:</label>
                        <select id="parentSelect" style="display:none;"></select>
                    </div>

                    <!-- القناة -->
                    <div id="channelFields" style="display:none;">
                        <label for="nameInput">اسم القناة:</label>
                        <input type="text" id="nameInputChannel" required />
                        <label for="imageInputChannel" id="labelImageInputChannel">رابط الشعار:</label>
                        <input type="text" id="imageInputChannel" />
                        
                        <label for="sectionTypeSelect">نوع القسم:</label>
                        <select id="sectionTypeSelect" onchange="onSectionTypeChange()">
                            <option value="main">قسم رئيسي</option>
                            <option value="sub">قسم فرعي</option>
                        </select>

                        <label for="categorySelect" id="labelCategorySelect">القسم:</label>
                        <select id="categorySelect"></select>

                        <label for="urlInput" id="labelUrlInput">رابط البث:</label>
                        <input type="text" id="urlInput" />
                    </div>

                    <div style="margin-top: 15px; text-align: center;">
                        <button type="submit" style="background:#28a745; color:white; padding:8px 15px; border:none; border-radius:5px;">حفظ</button>
                        <button type="button" onclick="closeModal()" style="background:#6c757d; color:white; padding:8px 15px; border:none; border-radius:5px; margin-left: 8px;">إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyARzpeY20p5R1RXGYX_83zQkyLHywp-SE4",
      authDomain: "one-sport-67e48.firebaseapp.com",
      databaseURL: "https://one-sport-67e48-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "one-sport-67e48",
      storageBucket: "one-sport-67e48.appspot.com",
      messagingSenderId: "238395812570",
      appId: "1:238395812570:web:6361f8ecac34d1061fd3e3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const categoriesRef = db.ref('categories');
    const channelsRef = db.ref('channels');

    const sectionsList = document.getElementById('sectionsList');
    const channelsList = document.getElementById('channelsList');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    const modalForm = document.getElementById('modalForm');

    // قسم الحقول
    const sectionFields = document.getElementById('sectionFields');
    const nameInput = document.getElementById('nameInput');
    const imageInput = document.getElementById('imageInput');
    const parentSelect = document.getElementById('parentSelect');
    const labelParentSelect = document.getElementById('labelParentSelect');

    // قناة الحقول
    const channelFields = document.getElementById('channelFields');
    const nameInputChannel = document.getElementById('nameInputChannel');
    const imageInputChannel = document.getElementById('imageInputChannel');
    const sectionTypeSelect = document.getElementById('sectionTypeSelect');
    const categorySelect = document.getElementById('categorySelect');
    const urlInput = document.getElementById('urlInput');

    let isEditingSection = false;
    let isEditingChannel = false;

    window.onload = () => {
        loadSections();
        loadChannels();
    };

    function loadSections() {
        categoriesRef.on('value', (snapshot) => {
            const categories = snapshot.val() || {};
            renderSections(categories);
        });
    }

    function loadChannels() {
        channelsRef.on('value', (snapshot) => {
            const channels = snapshot.val() || {};
            renderChannels(channels);
        });
    }

    function renderSections(categories) {
        sectionsList.innerHTML = '';
        // عرض الأقسام بشكل هرمي بسيط مع مسافة بادئة للأقسام الفرعية
        function renderTree(parentId = '', level = 0) {
            Object.entries(categories).forEach(([key, cat]) => {
                if ((cat.parent || '') === parentId) {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.style.paddingRight = (level * 20) + 'px';
                    div.innerHTML = `
                        <span>${cat.name}</span>
                        <div>
                            <button class="btn-edit" onclick="editSection('${key}')">تعديل</button>
                            <button class="btn-delete" onclick="deleteSection('${key}')">حذف</button>
                        </div>
                    `;
                    sectionsList.appendChild(div);
                    renderTree(key, level + 1);
                }
            });
        }
        renderTree();
    }

    function renderChannels(channels) {
        channelsList.innerHTML = '';
        const keys = Object.keys(channels).sort();
        keys.forEach(key => {
            const ch = channels[key];
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <span>${ch.name}</span>
                <div>
                    <button class="btn-edit" onclick="editChannel('${key}')">تعديل</button>
                    <button class="btn-delete" onclick="deleteChannel('${key}')">حذف</button>
                </div>
            `;
            channelsList.appendChild(div);
        });
    }

    // فتح نموذج إضافة قسم رئيسي
    function openAddMainSection() {
        isEditingSection = true;
        isEditingChannel = false;
        modalTitle.textContent = 'إضافة قسم رئيسي';
        resetForm();
        sectionFields.style.display = 'block';
        channelFields.style.display = 'none';
        parentSelect.style.display = 'none';
        labelParentSelect.style.display = 'none';
        modal.style.display = 'block';
    }

    // فتح نموذج إضافة قسم فرعي
    function openAddSubSection() {
        isEditingSection = true;
        isEditingChannel = false;
        modalTitle.textContent = 'إضافة قسم فرعي';
        resetForm();
        sectionFields.style.display = 'block';
        channelFields.style.display = 'none';
        labelParentSelect.style.display = 'block';
        parentSelect.style.display = 'block';

        categoriesRef.once('value').then(snapshot => {
            const categories = snapshot.val() || {};
            parentSelect.innerHTML = '';
            Object.entries(categories).forEach(([key, cat]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = cat.name;
                parentSelect.appendChild(option);
            });
        });

        modal.style.display = 'block';
    }

    // فتح نموذج إضافة قناة
    function openAddChannel() {
        isEditingSection = false;
        isEditingChannel = true;
        modalTitle.textContent = 'إضافة قناة جديدة';
        resetForm();
        sectionFields.style.display = 'none';
        channelFields.style.display = 'block';
        modal.style.display = 'block';

        sectionTypeSelect.value = 'main';
        onSectionTypeChange(); // تحميل الأقسام حسب النوع الافتراضي
    }

    // إعادة تعيين الحقول
    function resetForm() {
        modalForm.reset();
        document.getElementById('editId').value = '';
        nameInput.value = '';
        imageInput.value = '';
        parentSelect.innerHTML = '';
        nameInputChannel.value = '';
        imageInputChannel.value = '';
        urlInput.value = '';
        categorySelect.innerHTML = '';
    }

    // عند تغيير نوع القسم في إضافة القناة
    function onSectionTypeChange() {
        const type = sectionTypeSelect.value;
        categoriesRef.once('value').then(snapshot => {
            const categories = snapshot.val() || {};
            categorySelect.innerHTML = '';

            if (type === 'main') {
                // عرض الأقسام الرئيسية فقط (بدون أب)
                Object.entries(categories).forEach(([key, cat]) => {
                    if (!cat.parent || cat.parent === '') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = cat.name;
                        categorySelect.appendChild(option);
                    }
                });
            } else {
                // عرض الأقسام الفرعية فقط (لها أب)
                Object.entries(categories).forEach(([key, cat]) => {
                    if (cat.parent && cat.parent !== '') {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = cat.name;
                        categorySelect.appendChild(option);
                    }
                });
            }
        });
    }

    // حفظ النموذج (قسم أو قناة)
    modalForm.onsubmit = (e) => {
        e.preventDefault();

        if (isEditingSection) {
            // حفظ قسم
            const id = document.getElementById('editId').value;
            const name = nameInput.value.trim();
            const image = imageInput.value.trim();
            const parent = parentSelect.style.display !== 'none' ? parentSelect.value : '';

            if (!name) {
                alert('يرجى إدخال الاسم.');
                return;
            }

            const data = { name, image, parent: parent || '' };

            if (id) {
                categoriesRef.child(id).set(data)
                    .then(() => closeModal())
                    .catch(err => alert('خطأ في تحديث القسم: ' + err));
            } else {
                categoriesRef.push(data)
                    .then(() => closeModal())
                    .catch(err => alert('خطأ في إضافة القسم: ' + err));
            }

        } else if (isEditingChannel) {
            // حفظ قناة
            const id = document.getElementById('editId').value;
            const name = nameInputChannel.value.trim();
            const logo = imageInputChannel.value.trim();
            const category = categorySelect.value;
            const url = urlInput.value.trim();

            if (!name) {
                alert('يرجى إدخال اسم القناة.');
                return;
            }
            if (!category) {
                alert('يرجى اختيار القسم.');
                return;
            }

            const data = { name, logo, category, url };

            if (id) {
                channelsRef.child(id).set(data)
                    .then(() => closeModal())
                    .catch(err => alert('خطأ في تحديث القناة: ' + err));
            } else {
                channelsRef.push(data)
                    .then(() => closeModal())
                    .catch(err => alert('خطأ في إضافة القناة: ' + err));
            }
        }
    };

    // إغلاق النافذة المنبثقة
    function closeModal() {
        modal.style.display = 'none';
        resetForm();
    }

    // تعديل قسم
    function editSection(id) {
        isEditingSection = true;
        isEditingChannel = false;
        modalTitle.textContent = 'تعديل قسم';
        resetForm();
        sectionFields.style.display = 'block';
        channelFields.style.display = 'none';

        categoriesRef.child(id).once('value').then(snapshot => {
            const cat = snapshot.val();
            document.getElementById('editId').value = id;
            nameInput.value = cat.name || '';
            imageInput.value = cat.image || '';
            if (cat.parent && cat.parent !== '') {
                labelParentSelect.style.display = 'block';
                parentSelect.style.display = 'block';
                categoriesRef.once('value').then(snap => {
                    const categories = snap.val() || {};
                    parentSelect.innerHTML = '';
                    Object.entries(categories).forEach(([key, c]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = c.name;
                        if (key === cat.parent) option.selected = true;
                        parentSelect.appendChild(option);
                    });
                });
            } else {
                labelParentSelect.style.display = 'none';
                parentSelect.style.display = 'none';
            }
            modal.style.display = 'block';
        });
    }

    // تعديل قناة
    function editChannel(id) {
        isEditingSection = false;
        isEditingChannel = true;
        modalTitle.textContent = 'تعديل قناة';
        resetForm();
        sectionFields.style.display = 'none';
        channelFields.style.display = 'block';

        channelsRef.child(id).once('value').then(snapshot => {
            const ch = snapshot.val();
            document.getElementById('editId').value = id;
            nameInputChannel.value = ch.name || '';
            imageInputChannel.value = ch.logo || '';
            urlInput.value = ch.url || '';

            // تحديد نوع القسم حسب إذا القسم أب أم فرعي
            categoriesRef.child(ch.category).once('value').then(snap => {
                const cat = snap.val();
                if (cat) {
                    if (!cat.parent || cat.parent === '') {
                        sectionTypeSelect.value = 'main';
                    } else {
                        sectionTypeSelect.value = 'sub';
                    }
                } else {
                    sectionTypeSelect.value = 'main'; // افتراضياً
                }
                onSectionTypeChange();
                // تحديد القسم الصحيح
                setTimeout(() => {
                    categorySelect.value = ch.category;
                }, 100);
            });

            modal.style.display = 'block';
        });
    }

    // حذف قسم مع حذف قنواته الفرعية
    function deleteSection(id) {
        if (confirm('هل أنت متأكد من حذف هذا القسم؟ سيتم حذف جميع الأقسام الفرعية والقنوات التابعة له!')) {
            // حذف القسم مع جميع الأقسام الفرعية التابعة له
            categoriesRef.child(id).remove()
            .then(() => {
                // حذف جميع الأقسام الفرعية المرتبطة بالقسم المحذوف
                categoriesRef.once('value').then(snapshot => {
                    const categories = snapshot.val() || {};
                    Object.entries(categories).forEach(([key, cat]) => {
                        if (cat.parent === id) {
                            categoriesRef.child(key).remove();
                        }
                    });
                });
                // حذف جميع القنوات المرتبطة بهذا القسم أو أي قسم فرعي تحته
                channelsRef.once('value').then(snapshot => {
                    const channels = snapshot.val() || {};
                    Object.entries(channels).forEach(([key, ch]) => {
                        if (ch.category === id) {
                            channelsRef.child(key).remove();
                        } else {
                            // تحقق إذا القناة مرتبطة بقسم فرعي تابع
                            categoriesRef.child(ch.category).once('value').then(catSnap => {
                                if(catSnap.exists()) {
                                    const cat = catSnap.val();
                                    if(cat.parent === id){
                                        channelsRef.child(key).remove();
                                    }
                                }
                            });
                        }
                    });
                });
            });
        }
    }

    // حذف قناة
    function deleteChannel(id) {
        if (confirm('هل أنت متأكد من حذف هذه القناة؟')) {
            channelsRef.child(id).remove();
        }
    }
</script>
</body>
</html>
